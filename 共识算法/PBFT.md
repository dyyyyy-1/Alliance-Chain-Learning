# PBFT 概述

**PBFT**(Practical Byzantine Fault Tolerance)实用拜占庭容错共识算法可以在少数节点作恶(如伪造消息)场景中达成共识。该算法是Miguel Castro和Barbara Liskov在1999年提出来的，解决了原始拜占庭容错算法效率不高的问题，将算法复杂度由指数级降低到多项式级，使得拜占庭容错算法在实际系统应用中变得可行。

为了保证pbft算法的正确性，节点总数量n和作恶节点数量f必须满足n > 3f。

## 算法工作原理

算法的核心三个阶段分别是 pre-prepare 阶段（预准备阶段），prepare 阶段（准备阶段）， commit 阶段（提交阶段）。

![PBFT阶段图]()

图中的C代表客户端，0，1，2，3 代表节点的编号，打叉的3代表可能是故障节点或者是问题节点，这里表现的行为就是对其它节点的请求无响应。0 是主节点。整个过程大致是如下：

首先，客户端向主节点发起请求，主节点 0 收到客户端请求，会向其它节点发送 pre-prepare 消息，其它节点就收到了pre-prepare 消息，就开始了这个核心三阶段共识过程了。

- Pre-prepare 阶段：节点收到 pre-prepare 消息后，会有两种选择，一种是接受，一种是不接受。当发生视图编号错误、消息摘要不匹配或者消息摘要不匹配的时候就会拒绝请求。在这些情况下，节点会视预准备消息为无效，不会继续向后续阶段广播准备消息，从而确保共识过程的安全性和一致性。

- Prepare 阶段：节点同意请求后会向其它节点发送 prepare 消息。这里要注意一点，同一时刻不是只有一个节点在进行这个过程，可能有 n 个节点也在进行这个过程。因此节点是有可能收到其它节点发送的 prepare 消息的。在一定时间范围内，如果收到超过 2f 个不同节点的 prepare 消息，就代表 prepare 阶段已经完成。

- Commit 阶段：于是进入 commit 阶段。向其它节点广播 commit 消息，同理，这个过程可能是有 n 个节点也在进行的。因此可能会收到其它节点发过来的 commit 消息，当收到 2f+1 个 commit 消息后（包括自己），代表大多数节点已经进入 commit 阶段，这一阶段已经达成共识，于是节点就会执行请求，写入数据。

## PBFT 的优点和缺点

PBFT 对于区块链共识的一些**优点**包括：

1. 容错性： pBFT 专门设计为容错算法，使其能够处理节点故障。这在区块链共识等应用中非常重要，因为节点可能会在没有任何警告的情况下宕机。

2. 交易最终性：许多区块链共识算法，例如工作量证明或权益证明，仅具有概率最终性，这意味着在重组后，已接受的区块可能会从分布式账本中删除。pBFT 提供最终性，其中一定数量的节点批准的交易无法撤销。

3. 拜占庭容错： PBFT 是一种拜占庭容错算法。这意味着它可以处理网络中一定数量的恶意节点的存在。

PBFT 对于区块链共识的一些**缺点**包括：

1. 中心化： PBFT 使用领导节点来定义区块链上下一个区块的内容，并推动批准该区块的过程。这会产生一定程度的中心化，可能与区块链的核心原则背道而驰。

2. 可扩展性： PBFT 需要网络中一定比例的节点发送消息来确定区块的内容。这意味着消息数量会随着网络规模的扩大而扩大，从而限制了其可扩展性。

3. 网络开销：出于与可扩展性相同的原因，需要相互通信的节点越多，它消耗的带宽就越多。

4. 女巫攻击：PBFT 根据从网络中一定数量的节点接收的消息做出决策。如果攻击者控制许多不同的节点，他们就会拥有超额投票权，并可能批准恶意区块。


